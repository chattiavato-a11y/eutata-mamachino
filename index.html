<!doctype html>
<html lang="en" data-theme="dark">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat · Local-first with WebGPU fallback</title>
<style>
  :root{ --bg:#0b0c10; --card:#121319; --ink:#e6e6e6; --muted:#a9b0b8; --accent:#6ad1ff; --ring:rgba(106,209,255,.35); --status-color:#6ad1ff; --status-bg:rgba(106,209,255,.12); --warn-color:#ff7b7b; --warn-bg:rgba(255,123,123,.12); --warn-border:rgba(255,123,123,.45); }
  [data-theme="light"]{ --bg:#ffffff; --card:#f5f7fb; --ink:#1f2430; --muted:#536070; --accent:#0077ff; --ring:rgba(0,119,255,.25); --status-color:#0058cc; --status-bg:rgba(0,88,204,.14); --warn-color:#b00020; --warn-bg:rgba(176,0,32,.12); --warn-border:rgba(176,0,32,.4); }
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:900px;margin:0 auto;padding:20px}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
  .toggles{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,select{background:var(--card);color:var(--ink);border:1px solid #242634;border-radius:10px;padding:8px 12px}
  button:hover{outline:2px solid var(--ring)}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #242634;background:var(--card)}
  .chat{background:var(--card);border:1px solid #242634;border-radius:14px;padding:14px;height:60vh;overflow:auto}
  .msg{margin:8px 0;padding:10px 12px;border-radius:10px;white-space:pre-wrap}
  .me{background:rgba(106,209,255,.08);border:1px solid rgba(106,209,255,.25)}
  .ai{background:rgba(255,255,255,.03);border:1px solid #2a2d3b}
  .bar{display:flex;gap:8px;margin-top:10px}
  .bar textarea{flex:1;min-height:44px;max-height:160px;resize:vertical;background:var(--card);color:var(--ink);border:1px solid #242634;border-radius:10px;padding:10px}
  .muted{color:var(--muted);font-size:12px}
  .bad{color:var(--warn-color)}
  .status-message{color:var(--status-color);background:var(--status-bg);border-radius:10px;padding:8px 12px;font-size:13px;margin-top:6px;min-height:18px}
  .status-message[data-active="false"]{opacity:.7}
  .warn-message{color:var(--warn-color);background:var(--warn-bg);border:1px solid var(--warn-border);border-radius:10px;padding:8px 12px;font-size:13px;margin-top:8px}
  .warn-message[data-level=""]{display:none}
  .msg.ai:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .visually-hidden{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;border:0!important;white-space:nowrap!important}
</style>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>OPS Chat Interface</h1>
      </div>
      <div class="toggles" role="group" aria-label="Display and language settings">
        <label for="themeBtn" class="muted">Theme</label>
        <button id="themeBtn" type="button" aria-pressed="true">Dark</button>
        <label for="langSel" class="muted">Lang</label>
        <select id="langSel" aria-label="Language selector">
          <option value="en" selected>EN</option>
          <option value="es">ES</option>
        </select>
      </div>
    </header>

    <main>
      <section aria-labelledby="chat-title">
        <div class="policy-card">
          <h2 id="chat-title">Chattia</h2>
          <form id="chatForm" novalidate>
            <div id="chat" class="chat" role="log" aria-live="polite"></div>
            <div class="bar">
              <label class="visually-hidden" for="input">Chat message</label>
              <textarea id="input" placeholder="Type a message…" aria-label="Message input"></textarea>
              <button id="send" type="submit">Send</button>
            </div>
            <p id="assistantNavHint" class="visually-hidden">Press Escape to return to the composer after reviewing the latest assistant message.</p>
            <div class="muted status-message" id="status" role="status" aria-live="polite" data-active="false"></div>
            <div class="bad warn-message" id="warn" role="alert" aria-live="assertive" data-level=""></div>
          </form>
        </div>
      </section>

    </main>

    <footer>
      <nav class="footer-links" aria-label="Compliance policies">
        <details>
          <summary>Cookie Consent</summary>
          <p>By using this tool, you agree that essential cookies collect operational details needed for the service. We study aggregated chatbot interaction behavior strictly to improve responses, and no PII or other data beyond chat content is gathered.</p>
        </details>
        <details>
          <summary>Terms &amp; Conditions</summary>
          <p>Use of this chat interface signifies agreement to comply with all acceptable use policies, maintain confidentiality of outputs, and avoid transmitting malicious or unauthorized data.</p>
          <p>Services are provided “as is” with no warranty; uptime targets follow PCI DSS operational resilience guidelines, and jurisdiction is governed by applicable local laws.</p>
        </details>
        <details>
          <summary>Trademark &amp; Copyright</summary>
          <p>&copy; <span id="copyrightYear"></span> ShieldOps. All rights reserved. ShieldOps, the Shield logo, and related marks are trademarks of their respective owners.</p>
          <p>Unauthorized reproduction, distribution, or modification is prohibited without prior written consent. Third-party marks referenced are property of their owners.</p>
        </details>
      </nav>
    </footer>
  </div>

  <div id="cookieBanner" class="cookie-banner hidden" role="dialog" aria-live="polite" aria-modal="false" aria-label="Cookie consent">
    <div>
      <strong>L1 → L5 (extractive) → WebLLM/WebGPU (low confidence only) → L2/L3/L7</strong><br>
      <span class="muted">Local-first; external only if allowed. Budgeted 75k–100k tokens per session.</span>
    </div>
    <div class="toggles">
      <button id="themeBtn" aria-pressed="true">Dark</button>
      <label class="muted">Lang</label>
      <select id="langSel"><option value="en" selected>EN</option><option value="es">ES</option></select>
      <div class="pill" title="Routing Mode">
        <label class="muted">Mode</label>
        <select id="modeSel">
          <option value="hybrid" selected>Hybrid</option>
          <option value="local">Local only</option>
          <option value="external">External only</option>
        </select>
      </div>
      <div class="pill"><span class="muted">Session tokens:</span>&nbsp;<span id="budgetHint">0</span></div>
    </div>
    <div class="cookie-actions">
      <button id="declineCookies" type="button">Remind me later</button>
      <button id="acceptCookies" type="button">Agree &amp; continue</button>
    </div>
    <div class="muted" id="status"></div>
    <div class="bad" id="warn"></div>
  </form>
</div>

<script src="./shield.js"></script>
<script type="module">
import { routeChat } from './l6_orchestrator.js';

const qs=(s)=>document.querySelector(s);
const chat=qs('#chat'), inp=qs('#input'), send=qs('#send'), status=qs('#status'), warn=qs('#warn');
const langSel=qs('#langSel'); const themeBtn=qs('#themeBtn'); const form=qs('#chatForm');
const modeSel=qs('#modeSel'); const budgetHint=qs('#budgetHint');

const sanitizeForUi=(value)=>{
  try {
    const win = (typeof window !== 'undefined') ? window : undefined;
    const fn = win?.Shield?.baseSanitize;
    const sanitize = (typeof fn === 'function') ? fn : ((v)=>String(v||''));
    return sanitize(value||'');
  }
  catch { return String(value||''); }
};

const setStatus=(message)=>{
  const safe=sanitizeForUi(message);
  status.textContent=safe;
  status.dataset.active=safe? 'true':'false';
};

const setWarn=(message, level='warning')=>{
  const safe=sanitizeForUi(message);
  warn.textContent=safe;
  warn.dataset.level=safe? level:'';
};

// Honeypot + state
const hpInput = (()=>{ const hp=document.createElement('input'); hp.type='text'; hp.name='hp';
  hp.tabIndex=-1; hp.ariaHidden='true'; hp.style.cssText='position:absolute;left:-5000px;width:1px;height:1px;opacity:0;'; form.appendChild(hp); return hp; })();

const state={ messages:[], lang:'en', theme:'dark', csrf: csrfToken(), hp:'', mode:'hybrid', webllmModel:'Llama-3.1-8B-Instruct-q4f16_1' };

function csrfToken(){ const k='shield.csrf'; let t=sessionStorage.getItem(k); if(!t){ t=randomId(24); sessionStorage.setItem(k,t);} return t; }
function randomId(len=22){ const abc='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-'; let s=''; for(let i=0;i<len;i++) s+=abc[Math.floor(Math.random()*abc.length)]; return s; }

function addMsg(role, text){
  const isUser=role==='user';
  const d=document.createElement('div');
  d.className='msg '+(isUser?'me':'ai');
  d.textContent=text;
  if(!isUser){
    d.tabIndex=-1;
    d.setAttribute('role','article');
    d.setAttribute('aria-live','polite');
    d.setAttribute('aria-describedby','assistantNavHint');
    d.addEventListener('keydown',(ev)=>{
      if(ev.key==='Escape'){
        ev.preventDefault();
        inp.focus();
      }
    });
  }
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
  return d;
}

const focusAssistantBubble=(node)=>{
  if(!node||!node.classList.contains('ai')) return;
  requestAnimationFrame(()=>{
    try{ node.focus({ preventScroll:false }); }
    catch{ node.focus(); }
  });
};

themeBtn.onclick=()=>{ state.theme = state.theme==='dark'?'light':'dark';
  document.documentElement.dataset.theme=state.theme; themeBtn.textContent=state.theme[0].toUpperCase()+state.theme.slice(1); };
langSel.onchange=(e)=> state.lang = e.target.value;
modeSel.onchange=(e)=> state.mode = e.target.value;

// Budget hint updater (reads from server header or streaming text length via MutationObserver optional)
// Simple timer polling for demo:
setInterval(()=>{
  // naive: count all assistant text chars and estimate tokens
  const text = Array.from(document.querySelectorAll('.msg.ai')).map(n=>n.textContent||'').join('');
  budgetHint.textContent = Math.ceil(text.length/4);
}, 800);

function scanAndSanitize(input, maxLen=2000){
  const BIDI=/[\u202A-\u202E\u2066-\u2069\u200E\u200F\u061C\u200B-\u200D\uFEFF]/g, NULLS=/\x00/g;
  const DANG=/\b(?:javascript|vbscript|file|data):/gi, TAGS=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi, ON=/\bon\w+\s*=/gi, CSSURL=/url\(\s*(['"]?)(.*?)\1\s*\)/gi, IMP=/@import\s+['"]?[^'"]+['"]?/gi;
  const SUS=[/<script/i,/<\/script/i,/<iframe/i,/<object/i,/<embed/i,/<svg/i,/xlink:href/i,/onerror\s*=/i,/onload\s*=/i,/\.\.\//,/\b(select|union|insert|update|delete|drop)\b.*\bfrom\b/i,/\b(?:https?|ftp):\/\/[^\s]{2,}/i];
  function norm(s){ try{ return s.normalize('NFKC'); }catch{ return s; } }
  function scrub(s){ let out=s.replace(ON,'').replace(TAGS,'').replace(IMP,''); out=out.replace(CSSURL,(m,q,u)=>DANG.test((u||'').replace(/\s/g,''))?'url(about:blank)':m); out=out.replace(DANG,'about:blank:'); return out.replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  let t=String(input||''); t=norm(t).replace(BIDI,'').replace(NULLS,''); if(t.length>maxLen) t=t.slice(0,maxLen); t=scrub(t);
  const txt=t.toLowerCase(); let score=0,hits=[]; for(const re of SUS){ if(re.test(txt)){ score+=10; hits.push(re.source);} }
  const link=(txt.match(/\bhttps?:\/\//g)||[]).length; score+=Math.min(link*2,10); const ang=(t.match(/[<>]/g)||[]).length; score+=Math.min(ang,10);
  const ok=score<12; return { ok, sanitized:t, reasons: ok?[]:hits.slice(0,6) };
}

async function sendMsg(){
  const raw=(inp.value||'').trim(); if(!raw) return;
  const v1=scanAndSanitize(raw); if(!v1.ok){ setWarn('Blocked input.','error'); return; }
  setWarn('',''); addMsg('user', v1.sanitized);
  state.messages.push({role:'user', content:v1.sanitized, lang: state.lang}); inp.value=''; inp.focus();

  const result = await routeChat({
    state: { ...state, hp: hpInput.value||'' },
    ui: {
      chatEl:chat,
      warnEl:warn,
      statusEl:status,
      addMsg,
      focusAssistant:focusAssistantBubble,
      setStatus,
      setWarn
    }
  });

  if(result?.guardrails?.warnings?.length){
    const latest=result.guardrails.warnings[result.guardrails.warnings.length-1];
    if(latest?.message) setWarn(latest.message, latest.level||'warning');
  } else {
    setWarn('','');
  }
}

form?.addEventListener('submit',(ev)=>{ ev.preventDefault(); sendMsg(); });
send?.addEventListener('click',(ev)=>{ ev.preventDefault(); sendMsg(); });
inp?.addEventListener('keydown',(ev)=>{
  if(ev.key==='Enter' && !ev.shiftKey){
    ev.preventDefault();
    sendMsg();
  }
});
</script>
<script src="./app.js" defer></script>
</body>
</html>
